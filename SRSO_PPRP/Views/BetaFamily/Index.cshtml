@model SRSO_PPRP.Models.ReportViewModel

@{
    ViewData["Title"] = "Beta Family Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Include Toastr and jQuery -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Main content area -->
<div class="main-content">
    <h2 class="text-white">Beta Family Report</h2>

    <div class="form-container">
        <div class="form-row">
            <div class="form-group">
                <label for="districtDropdown" class="text-white">District</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                    </div>
                    <select id="districtDropdown" class="form-control custom-select" onchange="loadTehsils()">
                        <option value="">Select District</option>
                        @foreach (var district in ViewBag.Districts)
                        {
                            <option value="@district.DISTRICT_ID">@district.DISTRICT_NAME</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="tehsilDropdown" class="text-white">Tehsil</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-map"></i></span>
                    </div>
                    <select id="tehsilDropdown" class="form-control custom-select" onchange="loadUCs()" disabled>
                        <option value="">Select Tehsil</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="ucDropdown" class="text-white">Union Council</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                    </div>
                    <select id="ucDropdown" class="form-control custom-select" onchange="loadRVs()" disabled>
                        <option value="">Select UC</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="rvDropdown" class="text-white">Revenue Village</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-home"></i></span>
                    </div>
                    <select id="rvDropdown" class="form-control custom-select" onchange="loadVillages()" disabled>
                        <option value="">Select RV</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="villageDropdown" class="text-white">Village</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-village"></i></span>
                    </div>
                    <select id="villageDropdown" class="form-control custom-select" disabled>
                        <option value="">Select Village</option>
                    </select>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-generate-report" onclick="generateReport()">Generate Beta Report</button>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader" style="display: none;">
        <div class="spinner"></div>
    </div>
</div>

<style>
    /* Theme-specific styles */
    body {
        background-color: #1a1a2e; /* Dark background */
        color: #ffffff; /* White text */
        font-family: 'Arial', sans-serif;
    }

    .main-content {
        margin-left: 250px; /* Adjust based on sidebar width */
        padding: 20px;
        min-height: 100vh;
    }

    .form-container {
        background-color: #2a2a3e; /* Slightly lighter dark background for form */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px; /* Space between dropdowns */
    }

    .form-group {
        flex: 1;
        min-width: 200px; /* Minimum width for each dropdown */
    }

    .custom-select {
        background-color: #ffffff; /* White background for dropdowns */
        color: #000000; /* Black text for dropdown items */
        border: 1px solid #ffffff;
        border-radius: 5px;
        height: 38px;
        width: 100%;
    }

        .custom-select:focus {
            border-color: #ff007f; /* Pink border on focus */
            box-shadow: 0 0 5px rgba(255, 0, 127, 0.5);
            outline: none;
        }

    .input-group-text {
        background-color: #ff007f; /* Pink background for icons */
        color: #ffffff;
        border: 1px solid #ff007f;
        border-radius: 5px 0 0 5px;
    }

    .btn-generate-report {
        background-color: #ff007f; /* Pink button */
        color: #ffffff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
    }

        .btn-generate-report:hover {
            background-color: #e60073; /* Slightly darker pink on hover */
        }

    /* Ensure dropdown items are visible */
    .custom-select option {
        background-color: #ffffff;
        color: #000000;
    }

    /* Loader Styles */
    .loader {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        z-index: 1000;
    }

    .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #ff007f;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

   @@keyframes spin {
        0%

    {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }

    }
</style>

@section Scripts {
    <script src="https://kit.fontawesome.com/a076d05399.js"></script> <!-- Font Awesome for icons -->
    <script>
        // Cascading dropdown functions (unchanged)
        function loadTehsils() {
            var districtId = $('#districtDropdown').val();
            console.log("District ID selected:", districtId);
            if (!districtId) {
                $('#tehsilDropdown').prop('disabled', true).html('<option value="">Select Tehsil</option>');
                $('#ucDropdown').prop('disabled', true).html('<option value="">Select UC</option>');
                $('#rvDropdown').prop('disabled', true).html('<option value="">Select RV</option>');
                $('#villageDropdown').prop('disabled', true).html('<option value="">Select Village</option>');
                return;
            }

            $.ajax({
                url: '/BetaFamily/GetTehsils',
                type: 'POST',
                data: { districtId: districtId },
                success: function (data) {
                    console.log("Tehsils data received:", data);
                    var tehsilDropdown = $('#tehsilDropdown');
                    tehsilDropdown.prop('disabled', false).html('<option value="">Select Tehsil</option>');
                    if (data && data.length > 0) {
                        $.each(data, function (index, tehsil) {
                            tehsilDropdown.append($('<option>', {
                                value: tehsil.TEHSIL_ID,
                                text: tehsil.TEHSIL_NAME
                            }));
                        });
                    } else {
                        console.warn("No tehsils found for district:", districtId);
                    }

                    // Reset dependent dropdowns
                    $('#ucDropdown').prop('disabled', true).html('<option value="">Select UC</option>');
                    $('#rvDropdown').prop('disabled', true).html('<option value="">Select RV</option>');
                    $('#villageDropdown').prop('disabled', true).html('<option value="">Select Village</option>');
                },
                error: function (xhr, status, error) {
                    console.error("Error loading tehsils:", status, error, xhr.responseText);
                    alert('Error loading tehsils.');
                }
            });
        }

        function loadUCs() {
            var tehsilId = $('#tehsilDropdown').val();
            console.log("Tehsil ID selected:", tehsilId);
            if (!tehsilId) {
                $('#ucDropdown').prop('disabled', true).html('<option value="">Select UC</option>');
                $('#rvDropdown').prop('disabled', true).html('<option value="">Select RV</option>');
                $('#villageDropdown').prop('disabled', true).html('<option value="">Select Village</option>');
                return;
            }

            $.ajax({
                url: '/BetaFamily/GetUCs',
                type: 'POST',
                data: { tehsilId: tehsilId },
                success: function (data) {
                    console.log("UCs data received:", data);
                    var ucDropdown = $('#ucDropdown');
                    ucDropdown.prop('disabled', false).html('<option value="">Select UC</option>');
                    if (data && data.length > 0) {
                        $.each(data, function (index, uc) {
                            ucDropdown.append($('<option>', {
                                value: uc.UC_ID,
                                text: uc.UC_NAME
                            }));
                        });
                    } else {
                        console.warn("No UCs found for tehsil:", tehsilId);
                    }

                    // Reset dependent dropdowns
                    $('#rvDropdown').prop('disabled', true).html('<option value="">Select RV</option>');
                    $('#villageDropdown').prop('disabled', true).html('<option value="">Select Village</option>');
                },
                error: function (xhr, status, error) {
                    console.error("Error loading UCs:", status, error, xhr.responseText);
                    alert('Error loading UCs.');
                }
            });
        }

        function loadRVs() {
            var ucId = $('#ucDropdown').val();
            console.log("UC ID selected:", ucId);
            if (!ucId) {
                $('#rvDropdown').prop('disabled', true).html('<option value="">Select RV</option>');
                $('#villageDropdown').prop('disabled', true).html('<option value="">Select Village</option>');
                return;
            }

            $.ajax({
                url: '/BetaFamily/GetRVs',
                type: 'POST',
                data: { ucId: ucId },
                success: function (data) {
                    console.log("RVs data received:", data);
                    var rvDropdown = $('#rvDropdown');
                    rvDropdown.prop('disabled', false).html('<option value="">Select RV</option>');
                    if (data && data.length > 0) {
                        $.each(data, function (index, rv) {
                            rvDropdown.append($('<option>', {
                                value: rv.REVEUNEVILLAGE_ID,
                                text: rv.REVEUNE_VILLAGE_NAME
                            }));
                        });
                    } else {
                        console.warn("No RVs found for UC:", ucId);
                    }

                    // Reset dependent dropdowns
                    $('#villageDropdown').prop('disabled', true).html('<option value="">Select Village</option>');
                },
                error: function (xhr, status, error) {
                    console.error("Error loading RVs:", status, error, xhr.responseText);
                    alert('Error loading RVs.');
                }
            });
        }

        function loadVillages() {
            var rvId = $('#rvDropdown').val();
            console.log("RV ID selected:", rvId);
            if (!rvId) {
                $('#villageDropdown').prop('disabled', true).html('<option value="">Select Village</option>');
                return;
            }

            $.ajax({
                url: '/BetaFamily/GetVillages',
                type: 'POST',
                data: { rvId: rvId },
                success: function (data) {
                    console.log("Villages data received:", data);
                    var villageDropdown = $('#villageDropdown');
                    villageDropdown.prop('disabled', false).html('<option value="">Select Village</option>');
                    if (data && data.length > 0) {
                        $.each(data, function (index, village) {
                            villageDropdown.append($('<option>', {
                                value: village.VILLAGENAME_ID,
                                text: village.VILLAGE_NAME
                            }));
                        });
                    } else {
                        console.warn("No villages found for RV:", rvId);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error loading villages:", status, error, xhr.responseText);
                    alert('Error loading villages.');
                }
            });
        }

        function generateReport() {
            var villageId = $('#villageDropdown').val();
            console.log("Village ID selected for report:", villageId);
            if (!villageId) {
                toastr.error('Please select a village.');
                return;
            }

            // Show loader
            $('#loader').show();

            $.ajax({
                url: '/BetaFamily/GenerateReport',
                type: 'POST',
                data: { villageId: villageId },
                xhrFields: {
                    responseType: 'blob' // To handle binary data (PDF)
                },
                success: function (data, status, xhr) {
                    console.log("PDF generation successful");
                    $('#loader').hide(); // Hide loader on success

                    var blob = new Blob([data], { type: 'application/pdf' });
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = 'BetaFamilyReport.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Show Toastr success message
                    toastr.success('Report downloaded successfully!');
                },
                error: function (xhr, status, error) {
                    console.error("Error generating report:", status, error, xhr.responseText);
                    $('#loader').hide(); // Hide loader on error
                    try {
                        var response = JSON.parse(xhr.responseText);
                        toastr.error(response.message || 'Error generating report.');
                    } catch (e) {
                        toastr.error('Error generating report.');
                    }
                }
            });
        }

        // Initialize Toastr
        toastr.options = {
            "closeButton": true,
            "positionClass": "toast-top-right",
            "progressBar": true,
            "timeOut": "3000"
        };
    </script>
}